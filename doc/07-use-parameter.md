第7章 パラメーターの利用
=====

[↑目次](..\README.md "目次")

[←第6章 非問い合わせ](06-execute-non-query.md)

ここまでの章で基本的なCRUD処理を行うSQL実行が出来るようになりました。ただ、実際のアプリケーションでは、画面で入力した条件を使って、同じSQLを条件だけ変えて何度も実行するというケースが良くあります。本章ではこういったケースで使える「パラメーター」の使い方を学びます。

## 文字列連結での実行

まず、パラメーターを使わないケースを考えてみましょう。単純に考えれば、指定された値を元にWHERE句を文字列連結で組み立てることになるでしょう（リスト7-1）。

リスト6-1 パラメーター未使用（Program.csのMainメソッドより）

```csharp
Console.Write("検索したい社員名の先頭を入力してください : ");
var ename = Console.ReadLine();

// ①文字列連結
using (var dbCommand = dbConnection.CreateCommand())
{
  dbCommand.CommandText = $@"
    select
     COUNT(EMPNO)
    from
     EMP
    where
     ENAME like '{ename}%'
  ";

  var employeeCount = Convert.ToInt32(dbCommand.ExecuteScalar());
  Console.WriteLine($"該当社員数 : {employeeCount}");
}
```

ここでは例として、Console.ReadLineメソッドを使い、コンソールの標準入力から検索条件の社員名を取得して使っています。例えば、"J"を指定して実行すると、該当データが2件になります。

```
検索したい社員名の先頭を入力してください : J
該当社員数 : 2
```

## 文字列連結の問題点

文字列連結でも対象データ件数は正しく取得できていますし、何も問題無いように思えるかもしれません。しかし、実は重大な問題があります。それは「SQLインジェクション」と呼ばれるセキュリティ上の脆弱性です。

例えば、文字列連結のプログラムを実行したとき、社員名の先頭文字に"' OR 1=1 --"と入力して実行すると、なんと全件数が表示されてしまいました。

```
検索したい社員名の先頭を入力してください : ' OR 1=1 --
該当社員数 : 14
```

どうしてこのようなことになるのでしょう？それはSQL文を実際に組み立ててみればわかります。まず、文字列を埋め込む前のSQLは次のようになっています。

```
select
 COUNT(EMPNO)
from
 EMP
where
 ENAME like '%'
```

ここに先ほどの"' OR 1=1 --"を埋め込んでみるとどうなるでしょう？

```
select
 COUNT(EMPNO)
from
 EMP
where
 ENAME like '' OR 1=1 --%'
```

すると、like演算子で指定した条件と1=1という条件がOR演算子で演算され、その結果必ずTRUE担ってしまいます。したがって、いつでもTRUE＝全件が該当と判断されてしまいます。

この例では単に常にTRUEになるように条件を変更しただけですが、"';DROP TABLE EMP;--"が次のように埋め込まれたら、ユーザーの操作でテーブルを削除できてしまいます。

```
select
 COUNT(EMPNO)
from
 EMP
where
 ENAME like '';DROP TABLE EMP;--%'
```

この他、任意のユーザーの情報を始めといった機密情報を抜き取ったりと、SQLで出来ることは何でも好きに実行できてしまうのです。

こういったSQL文を注入（インジェクション）出来てしまう脆弱性を「SQLインジェクション」と呼びます。仕組みはシンプルですが、非常に怖い脆弱性で、過去には大きなシステム障害の原因にもなっています。

参考：[2014年を揺るがしたインジェクション攻撃の手口と対策 - IT、IT製品の情報なら【キーマンズネット】](http://www.keyman.or.jp/at/30007393/)

このSQLインジェクションの脆弱性を防ぐのに最も有効な手段が、「パラメーター」の利用です。

[→第8章 ストアド・プロシージャ](08-call-stored-procedure.md)
